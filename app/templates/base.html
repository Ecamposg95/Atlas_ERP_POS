<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}DataX POS{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#172033', 950: '#020617' },
                        primary: {
                            500: '#2EA98C',
                            600: '#17876E',
                            700: '#085543',
                            900: '#0B4539'
                        }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        /* Estilos Base & Glassmorphism */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
            --body-bg: #f8fafc;
            /* slate-50 */
            --text-main: #0f172a;
            /* slate-900 */
        }

        html.dark {
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-border: rgba(255, 255, 255, 0.05);
            --body-bg: #020617;
            /* slate-950 */
            --text-main: #f1f5f9;
            /* slate-100 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-main);
        }

        .dashboard-bg {
            background: radial-gradient(circle at top left, #1e1b4b 0%, #020617 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border-right: 1px solid var(--glass-border);
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #2EA98C;
            transform: scaleY(0);
            transition: transform 0.3s;
        }

        .nav-item:hover::before,
        .nav-item.active::before {
            transform: scaleY(1);
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(46, 169, 140, 0.1);
            color: inherit;
        }

        html.dark .nav-item:hover,
        html.dark .nav-item.active {
            color: white;
        }

        /* Scrollbar Personalizado */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            /* slate-400 */
            border-radius: 3px;
        }

        html.dark ::-webkit-scrollbar-thumb {
            background: #475569;
            /* slate-600 */
        }

        /* Utilidades */
        .hidden {
            display: none;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

            {
            % block extra_css %
        }

            {
            % endblock %
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300 overflow-hidden">

    <!-- Wrapper Principal -->
    <div id="app-root"
        class="flex h-screen w-full bg-slate-50 dark:bg-slate-950 opacity-0 transition-opacity duration-500">

        <!-- Sidebar -->
        <aside class="w-20 lg:w-64 flex flex-col bg-[#0f172a] z-20 transition-all duration-300 border-r border-white/5">
            <!-- Logo -->
            <div class="h-16 flex items-center justify-between px-4 border-b border-white/5">
                <div class="flex items-center justify-center w-full lg:w-auto">
                    <div
                        class="w-8 h-8 bg-gradient-to-br from-primary-600 to-primary-900 rounded-lg flex items-center justify-center text-white font-bold text-xs shadow-lg shadow-primary-900/20">
                        AT
                    </div>
                    <span
                        class="hidden lg:block ml-3 font-bold text-white tracking-tight text-sm sidebar-text">Atlas</span>
                </div>
                <button id="sidebar-toggle" class="hidden lg:block text-slate-500 hover:text-white transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                    </svg>
                </button>
            </div>

            <!-- Store Info -->
            <div class="px-4 py-4 border-b border-white/5 bg-slate-900/50 sidebar-text hidden lg:block">
                <div class="flex items-center gap-3">
                    <div
                        class="w-8 h-8 rounded-lg bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center text-emerald-400">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                            </path>
                        </svg>
                    </div>
                    <div class="overflow-hidden">
                        <p class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Sucursal</p>
                        <p class="text-xs font-bold text-slate-200 truncate" id="store-name">Matriz Principal</p>
                    </div>
                </div>
            </div>

            <!-- Navegación -->
            <nav class="flex-1 py-6 space-y-1 px-2 overflow-y-auto custom-scrollbar">
                <a href="/home" id="nav-home"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/home' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Inicio</span>
                </a>

                <a href="/" id="nav-dashboard"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/' or request.path == '/index' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Dashboard</span>
                </a>

                <div class="my-2 border-t border-white/5 mx-2"></div>

                <a href="/pos" id="nav-pos"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/pos' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Punto de Venta</span>
                </a>

                <a href="/sales" id="nav-sales"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/sales' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Ventas</span>
                </a>

                <a href="/cash-history" id="nav-cash"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/cash-history' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Cortes de Caja</span>
                </a>

                <div class="my-2 border-t border-white/5 mx-2"></div>

                <a href="/products" id="nav-products"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/products' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Productos</span>
                </a>

                <a href="/inventory" id="nav-inventory"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/inventory' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Inventario</span>
                </a>

                <a href="/departments" id="nav-departments"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/departments' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Departamentos</span>
                </a>

                <div class="my-2 border-t border-white/5 mx-2"></div>

                <a href="/customers" id="nav-customers"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/customers' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Clientes CRM</span>
                </a>

                <a href="/users" id="nav-users"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/users' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Usuarios</span>
                </a>

                <a href="/organization" id="nav-organization"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/organization' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Organización</span>
                </a>

                <a href="/quotes" id="nav-quotes"
                    class="nav-item flex items-center px-3 py-2 text-slate-400 rounded-lg group {% if request.path == '/quotes' %}active text-white bg-white/5{% endif %}">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Cotizaciones</span>
                </a>

                <div class="my-4 border-t border-white/5 mx-4"></div>

                <a href="#" id="logout-btn"
                    class="nav-item flex items-center px-3 py-2 text-red-400 hover:text-red-300 hover:bg-red-500/10 rounded-lg group transition-colors">
                    <svg class="w-5 h-5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1">
                        </path>
                    </svg>
                    <span class="hidden lg:block ml-3 font-medium text-xs sidebar-text">Cerrar Sesión</span>
                </a>
            </nav>

            <!-- User Profile Short -->
            <div class="p-4 border-t border-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-xs font-bold ring-2 ring-slate-800 text-white"
                        id="user-avatar">
                        U
                    </div>
                    <div class="hidden lg:block overflow-hidden">
                        <p class="text-sm font-bold text-white truncate" id="user-name">Usuario</p>
                        <p class="text-xs text-slate-500 truncate" id="user-role">Rol</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col min-w-0 relative h-full overflow-hidden">
            <!-- Global Header -->
            <header
                class="h-16 bg-white/50 dark:bg-slate-900/50 backdrop-blur border-b border-slate-200 dark:border-white/5 flex items-center justify-between px-6 shrink-0 z-20">

                <!-- Left: Title Area -->
                <div class="flex items-center gap-4">
                    {% block header_title %}
                    <!-- Default Title (can be overridden) -->
                    <div>
                        <h1 class="text-lg font-bold text-slate-800 dark:text-white tracking-tight">Atlas POS</h1>
                    </div>
                    {% endblock %}
                </div>

                <!-- Right: Actions & Theme -->
                <div class="flex items-center gap-3">
                    {% block header_actions %}
                    <!-- Child templates can inject actions here -->
                    {% endblock %}

                    <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>

                    <button id="theme-toggle"
                        class="p-2 rounded-lg text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-white/5 transition-colors focus:outline-none">
                        <!-- Sun Icon (Light Mode) -->
                        <svg id="icon-light" class="w-5 h-5 hidden" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z">
                            </path>
                        </svg>
                        <!-- Moon Icon (Dark Mode) -->
                        <svg id="icon-dark" class="w-5 h-5 hidden" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 24.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                            </path>
                        </svg>
                        <span class="sr-only">Cambiar Tema</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-hidden relative flex flex-col">
                <div class="flex-1 overflow-y-auto custom-scrollbar relative">
                    {% block content %}{% endblock %}
                </div>
            </div>

            <!-- Footer -->
            <footer
                class="h-8 bg-white dark:bg-slate-950 border-t border-slate-200 dark:border-white/5 flex items-center justify-between px-4 text-[10px] text-slate-500 shrink-0 z-20">
                <div>
                    Powered by <span class="font-bold text-primary-600 dark:text-primary-500">Atlas Tech</span> & <span
                        class="font-bold text-primary-600 dark:text-primary-500">Smart Site Co</span>
                </div>
                <div id="footer-clock" class="font-mono font-medium">--/--/---- --:--:--</div>
            </footer>
        </main>
    </div>

    <!-- Modals & Overlays -->
    {% block modals %}{% endblock %}

    <!-- Global Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm transition-opacity opacity-0"
            id="profile-modal-backdrop"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">

                <div class="relative transform overflow-hidden rounded-2xl bg-[#0f172a] border border-white/10 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    id="profile-modal-panel">
                    <!-- Header -->
                    <div class="px-6 py-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                        <h3 class="text-base font-semibold leading-6 text-white" id="modal-title">Mi Perfil</h3>
                        <button onclick="closeProfileModal()"
                            class="text-slate-400 hover:text-white transition-colors outline-none">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path
                                    d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                            </svg>
                        </button>
                    </div>

                    <!-- Body -->
                    <div class="px-6 py-6">
                        <form id="profile-form" class="space-y-4">
                            <input type="hidden" id="profile-id">

                            <!-- Username (Readonly) -->
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Usuario</label>
                                <input type="text" id="profile-username"
                                    class="w-full bg-slate-900 border border-slate-700/50 rounded-lg px-3 py-2 text-slate-500 text-sm focus:outline-none cursor-not-allowed"
                                    readonly>
                            </div>

                            <!-- Role (Readonly) -->
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Rol</label>
                                <input type="text" id="profile-role-display"
                                    class="w-full bg-slate-900 border border-slate-700/50 rounded-lg px-3 py-2 text-slate-500 text-sm focus:outline-none cursor-not-allowed"
                                    readonly>
                            </div>

                            <!-- Full Name -->
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Nombre Completo</label>
                                <input type="text" id="profile-fullname"
                                    class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:ring-1 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all placeholder-slate-600"
                                    placeholder="Tu nombre completo">
                            </div>

                            <!-- Password -->
                            <div>
                                <label class="block text-xs font-medium text-slate-400 mb-1">Nueva Contraseña <span
                                        class="text-slate-600">(Opcional)</span></label>
                                <div class="relative">
                                    <input type="password" id="profile-password"
                                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:ring-1 focus:ring-primary-500 focus:border-primary-500 outline-none transition-all placeholder-slate-600"
                                        placeholder="••••••••">
                                </div>
                                <p class="mt-1 text-[10px] text-slate-500">Deja en blanco para mantener la actual.</p>
                            </div>

                            <!-- Error/Success Msg -->
                            <div id="profile-msg" class="hidden p-3 rounded-lg text-xs text-center font-medium"></div>

                            <div class="pt-4 flex justify-end gap-3">
                                <button type="button" onclick="closeProfileModal()"
                                    class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-sm font-medium rounded-lg transition-colors">Cancelar</button>
                                <button type="submit" id="save-profile-btn"
                                    class="px-4 py-2 bg-primary-600 hover:bg-primary-500 text-white text-sm font-bold rounded-lg shadow-lg shadow-primary-900/20 transition-all">Guardar
                                    Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Logic
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Check Auth
            const token = sessionStorage.getItem('ACCESS_TOKEN');
            const userStr = sessionStorage.getItem('CURRENT_USER');

            if (!token && window.location.pathname !== '/login') {
                window.location.href = '/login';
                return;
            }

            // 2. Show UI
            document.getElementById('app-root').classList.remove('opacity-0');

            // 3. Global User Fetch & State
            let currentUserData = null;

            async function refreshUserData() {
                try {
                    const res = await fetch('/api/users/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (res.ok) {
                        const user = await res.json();
                        currentUserData = user;

                        // Update UI
                        document.getElementById('user-name').textContent = user.username || 'Usuario';
                        document.getElementById('user-role').textContent = user.role || 'Rol';
                        document.getElementById('user-avatar').textContent = (user.username || 'U').charAt(0).toUpperCase();

                        // Update Store Info
                        // Ideally trigger a fetch for branch name here if needed
                        // For now, assume 'Matriz Principal' is default or show ID
                        if (user.branch_id) {
                            // document.getElementById('store-name').textContent = `Sucursal ${user.branch_id}`; 
                            // Check if we can fetch branch name? 
                            // Let's just keep 'Matriz Principal' unless we want to fetch more.
                            // Or simpler: "Atlas POS - Sucursal <ID>"
                            document.getElementById('store-name').textContent = `Sucursal ${user.branch_id}`;
                        }

                        // Update SessionStorage if needed (optional)
                        sessionStorage.setItem('CURRENT_USER', JSON.stringify(user));

                        applyRoleRestrictions(user);
                    }
                } catch (e) {
                    console.error('Error fetching user data', e);
                }
            }

            function applyRoleRestrictions(user) {
                if (user.role === 'CAJERO') {
                    const restrictedIds = [
                        'nav-dashboard', 'nav-departments', 'nav-customers',
                        'nav-users', 'nav-organization', 'nav-quotes'
                    ];
                    restrictedIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.classList.add('hidden');
                    });
                }
            }

            // Init Data
            if (token) refreshUserData();


            // 4. Sidebar Toggle
            const sidebar = document.querySelector('aside');
            const sidebarBtn = document.getElementById('sidebar-toggle');
            const sidebarTexts = document.querySelectorAll('.sidebar-text');
            const userLabels = document.querySelector('#user-name')?.parentElement;

            let isCollapsed = localStorage.getItem('sidebar_collapsed') === 'true';

            function updateSidebar() {
                if (isCollapsed) {
                    sidebar.classList.remove('lg:w-64');
                    sidebar.classList.add('lg:w-20');
                    sidebarTexts.forEach(el => el.classList.add('lg:hidden'));
                    if (userLabels) userLabels.classList.add('lg:hidden');
                } else {
                    sidebar.classList.add('lg:w-64');
                    sidebar.classList.remove('lg:w-20');
                    sidebarTexts.forEach(el => el.classList.remove('lg:hidden'));
                    if (userLabels) userLabels.classList.remove('lg:hidden');
                }
            }
            updateSidebar();

            sidebarBtn?.addEventListener('click', () => {
                isCollapsed = !isCollapsed;
                localStorage.setItem('sidebar_collapsed', isCollapsed);
                updateSidebar();
            });

            // 5. Theme Toggle
            const themeToggleBtn = document.getElementById('theme-toggle');
            const iconLight = document.getElementById('icon-light');
            const iconDark = document.getElementById('icon-dark');
            const htmlClass = document.documentElement.classList;

            const storedTheme = localStorage.getItem('theme');
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            let isDark = storedTheme === 'dark' || (!storedTheme && systemDark);

            function updateThemeUI() {
                if (isDark) {
                    htmlClass.add('dark');
                    iconLight.classList.remove('hidden');
                    iconDark.classList.add('hidden');
                } else {
                    htmlClass.remove('dark');
                    iconLight.classList.add('hidden');
                    iconDark.classList.remove('hidden');
                }
            }
            updateThemeUI();

            themeToggleBtn?.addEventListener('click', () => {
                isDark = !isDark;
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeUI();
            });

            // 6. Clock
            const clockEl = document.getElementById('footer-clock');
            function updateClock() {
                if (clockEl) {
                    const now = new Date();
                    clockEl.textContent = now.toLocaleString('es-MX', {
                        day: '2-digit', month: '2-digit', year: 'numeric',
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
                    });
                }
            }
            setInterval(updateClock, 1000);
            updateClock();

            // 7. Logout
            document.getElementById('logout-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                sessionStorage.clear();
                window.location.href = '/login';
            });


            // --- PROFILE MODAL LOGIC ---
            const profileModal = document.getElementById('profile-modal');
            const profileBackdrop = document.getElementById('profile-modal-backdrop');
            const profilePanel = document.getElementById('profile-modal-panel');
            const profileForm = document.getElementById('profile-form');

            window.openProfileModal = () => {
                if (!currentUserData) return;

                // Populate
                document.getElementById('profile-id').value = currentUserData.id;
                document.getElementById('profile-username').value = currentUserData.username;
                document.getElementById('profile-role-display').value = currentUserData.role;
                document.getElementById('profile-fullname').value = currentUserData.full_name || '';
                document.getElementById('profile-password').value = ''; // clear
                document.getElementById('profile-msg').classList.add('hidden');

                profileModal.classList.remove('hidden');
                setTimeout(() => {
                    profileBackdrop.classList.remove('opacity-0');
                    profilePanel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                }, 10);
            };

            window.closeProfileModal = () => {
                profileBackdrop.classList.add('opacity-0');
                profilePanel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                setTimeout(() => {
                    profileModal.classList.add('hidden');
                }, 300);
            };

            // Trigger via Sidebar Profile Area
            const sidebarProfile = document.querySelector('aside .p-4.border-t');
            if (sidebarProfile) {
                sidebarProfile.classList.add('cursor-pointer', 'hover:bg-slate-800', 'transition-colors');
                sidebarProfile.title = "Editar Perfil";
                sidebarProfile.onclick = window.openProfileModal;
            }

            // Save Profile
            profileForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('save-profile-btn');
                const originalText = btn.innerHTML;
                const msgDiv = document.getElementById('profile-msg');
                const userId = document.getElementById('profile-id').value;

                btn.disabled = true;
                btn.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                msgDiv.classList.add('hidden');

                const payload = {
                    full_name: document.getElementById('profile-fullname').value.trim(),
                    password: document.getElementById('profile-password').value || undefined
                };

                try {
                    const res = await fetch(`/api/users/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) throw new Error('Error al actualizar perfil');

                    const updatedUser = await res.json();

                    // Success
                    msgDiv.textContent = 'Perfil actualizado correctamente';
                    msgDiv.className = 'p-3 rounded-lg text-xs text-center font-medium bg-emerald-500/10 text-emerald-400 block';

                    // Refresh local data
                    await refreshUserData();

                    setTimeout(() => {
                        window.closeProfileModal();
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }, 1000);

                } catch (err) {
                    msgDiv.textContent = err.message;
                    msgDiv.className = 'p-3 rounded-lg text-xs text-center font-medium bg-red-500/10 text-red-400 block';
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
        });
    </script>
    {% block scripts %}{% endblock %}
</body>

</html>