{% extends "base.html" %}

{% block title %}Historial de Ventas - Atlas ERP{% endblock %}

{% block header_title %}
<div>
    <h1 class="text-lg font-bold text-slate-800 dark:text-white tracking-tight">Historial de Ventas</h1>
    <p class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-widest font-semibold">
        Transacciones
    </p>
</div>
{% endblock %}

{% block header_actions %}
<div class="flex flex-col md:flex-row gap-4 items-end md:items-center">
    <!-- Quick Filters -->
    <div class="flex bg-slate-800 p-1 rounded-lg border border-white/5">
        <button onclick="setFilter('today')"
            class="px-3 py-1 text-xs font-medium text-slate-400 hover:text-white hover:bg-white/10 rounded-md transition">Hoy</button>
        <button onclick="setFilter('yesterday')"
            class="px-3 py-1 text-xs font-medium text-slate-400 hover:text-white hover:bg-white/10 rounded-md transition">Ayer</button>
        <button onclick="setFilter('week')"
            class="px-3 py-1 text-xs font-medium text-slate-400 hover:text-white hover:bg-white/10 rounded-md transition">Semana</button>
        <button onclick="setFilter('month')"
            class="px-3 py-1 text-xs font-medium text-slate-400 hover:text-white hover:bg-white/10 rounded-md transition">Mes</button>
    </div>

    <!-- Date Range -->
    <div
        class="flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1 rounded-lg border border-slate-200 dark:border-slate-700">
        <input type="date" id="filter-date-start"
            class="bg-transparent text-xs text-slate-600 dark:text-slate-300 outline-none px-2 py-1 w-28">
        <span class="text-slate-400">-</span>
        <input type="date" id="filter-date-end"
            class="bg-transparent text-xs text-slate-600 dark:text-slate-300 outline-none px-2 py-1 w-28">
        <button id="refresh-btn" class="p-1 rounded text-slate-400 hover:text-white hover:bg-slate-700 transition"
            title="Actualizar">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                </path>
            </svg>
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6 animate-fade-in">
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Card 1: Venta Total -->
        <div class="glass-card p-5 rounded-2xl border border-white/5 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <svg class="w-16 h-16 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
            </div>
            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Ventas Totales</p>
            <h3 id="kpi-total" class="text-2xl font-bold text-white">$0.00</h3>
        </div>

        <!-- Card 2: Tickets -->
        <div class="glass-card p-5 rounded-2xl border border-white/5 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <svg class="w-16 h-16 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                    </path>
                </svg>
            </div>
            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Transacciones</p>
            <h3 id="kpi-count" class="text-2xl font-bold text-white">0</h3>
        </div>

        <!-- Card 3: Ticket Promedio -->
        <div class="glass-card p-5 rounded-2xl border border-white/5 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <svg class="w-16 h-16 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                </svg>
            </div>
            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Ticket Promedio</p>
            <h3 id="kpi-average" class="text-2xl font-bold text-white">$0.00</h3>
        </div>

        <!-- Card 4: Método Principal -->
        <div class="glass-card p-5 rounded-2xl border border-white/5 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                <svg class="w-16 h-16 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                    </path>
                </svg>
            </div>
            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-1">Top Método Pago</p>
            <h3 id="kpi-top-method" class="text-xl font-bold text-white truncate">-</h3>
        </div>
    </div>
    <!-- Sales Table -->
    <div class="glass-card rounded-2xl overflow-hidden border border-white/5">
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-slate-900/50 text-slate-400 text-xs uppercase tracking-wider border-b border-white/5">
                        <th class="p-4 font-semibold">Folio</th>
                        <th class="p-4 font-semibold">Fecha</th>
                        <th class="p-4 font-semibold">Cliente</th>
                        <th class="p-4 font-semibold text-right">Total</th>
                        <th class="p-4 font-semibold text-center">Estado</th>
                        <th class="p-4 font-semibold text-right">Acciones</th>
                    </tr>
                </thead>
                <tbody id="sales-table-body" class="text-sm divide-y divide-white/5">
                    <!-- Loaded via JS -->
                    <tr>
                        <td colspan="6" class="p-8 text-center text-slate-500 italic">Cargando ventas...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="p-4 border-t border-white/5 bg-slate-900/30 flex justify-between items-center">
            <span class="text-xs text-slate-500" id="showing-info">Mostrando últimos 100 registros</span>
            <div class="flex gap-2">
                <button id="prev-page"
                    class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-xs disabled:opacity-50">Anterior</button>
                <button id="next-page"
                    class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-xs disabled:opacity-50">Siguiente</button>
            </div>
        </div>
    </div>
</div>

<!-- Sale Details Modal -->
<div id="details-modal"
    class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
    <div
        class="bg-slate-900 border border-white/10 rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-white/10 flex justify-between items-center bg-slate-950/50">
            <div>
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <span id="detail-folio">Folio #000</span>
                    <span id="detail-status"
                        class="text-[10px] px-2 py-0.5 rounded-full bg-slate-800 text-slate-400">STATUS</span>
                </h3>
                <p id="detail-date" class="text-xs text-slate-400">Fecha: -</p>
            </div>
            <button id="close-details-btn" class="text-slate-400 hover:text-white transition">✕</button>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <!-- Items -->
            <div>
                <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Productos</h4>
                <div class="border rounded-xl border-white/5 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-800/50 text-slate-400 text-xs">
                            <tr>
                                <th class="p-2 text-left">Desc</th>
                                <th class="p-2 text-center">Cant</th>
                                <th class="p-2 text-right">P. Unit</th>
                                <th class="p-2 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="detail-items" class="divide-y divide-white/5 text-slate-300"></tbody>
                    </table>
                </div>
            </div>

            <!-- Totals -->
            <div class="flex justify-end gap-12">
                <div class="text-right space-y-1">
                    <p class="text-xs text-slate-500">Total Venta</p>
                    <p id="detail-total" class="text-2xl font-bold text-emerald-400">$0.00</p>
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="px-6 py-4 border-t border-white/10 bg-slate-950/50 flex justify-end gap-3">
            <button id="reprint-btn"
                class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2-2v4h10z">
                    </path>
                </svg>
                Reimprimir Ticket
            </button>
            <button id="return-btn"
                class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-rose-400 hover:text-white rounded-lg text-sm font-medium transition flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                </svg>
                Devolución
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE = 'http://127.0.0.1:8000';
        const ACCESS_TOKEN = sessionStorage.getItem('ACCESS_TOKEN');
        if (!ACCESS_TOKEN) window.location.href = '/auth';

        let currentSales = [];

        // --- FETCH SALES & STATS ---
        async function loadSales() {
            const tbody = document.getElementById('sales-table-body');
            // Show loading state in table only if it's empty or explicitly desired
            if (!currentSales.length) tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500 italic">Cargando...</td></tr>';

            const start = document.getElementById('filter-date-start').value;
            const end = document.getElementById('filter-date-end').value;
            let query = '?limit=100';
            if (start) query += `&start_date=${start}`;
            if (end) query += `&end_date=${end}`;

            // Load Stats in Parallel
            loadStats(query);

            try {
                const res = await fetch(`${API_BASE}/api/sales/${query}`, {
                    headers: { 'Authorization': `Bearer ${ACCESS_TOKEN}` }
                });
                if (!res.ok) throw new Error('Error al cargar ventas');

                const data = await res.json();
                currentSales = data;
                renderTable(data);
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-rose-500 font-bold">Error: ${e.message}</td></tr>`;
            }
        }

        async function loadStats(query) {
            try {
                // If query starts with ?, use it. If not (empty), append ?
                const q = query.startsWith('?') ? query : '?' + query;
                const res = await fetch(`${API_BASE}/api/sales/stats${q}`, {
                    headers: { 'Authorization': `Bearer ${ACCESS_TOKEN}` }
                });
                if (!res.ok) return; // Silent fail for stats

                const data = await res.json();

                // Animate Numbers (Simple)
                document.getElementById('kpi-total').textContent = `$${data.total_sales.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                document.getElementById('kpi-count').textContent = data.total_transactions;
                document.getElementById('kpi-average').textContent = `$${data.average_ticket.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                // Top Method
                let topMethod = '-';
                let maxAmount = 0;
                for (const [method, amount] of Object.entries(data.payment_methods)) {
                    if (amount > maxAmount) {
                        maxAmount = amount;
                        // Map specific keys if needed, e.g. 'CASH' -> 'Efectivo'
                        topMethod = method === 'CASH' ? 'Efectivo' : (method === 'CARD' ? 'Tarjeta' : (method === 'TRANSFER' ? 'Transf.' : method));
                    }
                }
                document.getElementById('kpi-top-method').textContent = topMethod;

            } catch (e) {
                console.error("Error loading stats", e);
            }
        }

        window.setFilter = function (range) {
            const now = new Date();
            let start = new Date();
            let end = new Date();

            if (range === 'today') {
                // Start = Today 00:00, End = Now (or End of Day)
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
            } else if (range === 'yesterday') {
                start.setDate(now.getDate() - 1);
                start.setHours(0, 0, 0, 0);
                end.setDate(now.getDate() - 1);
                end.setHours(23, 59, 59, 999);
            } else if (range === 'week') {
                // First day of current week (assuming Monday start)
                const day = now.getDay();
                const diff = now.getDate() - day + (day == 0 ? -6 : 1); // adjust when day is sunday
                start.setDate(diff);
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
            } else if (range === 'month') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
                end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            }

            // Format YYYY-MM-DD
            const fmt = (d) => d.toISOString().split('T')[0];
            document.getElementById('filter-date-start').value = fmt(start);
            document.getElementById('filter-date-end').value = fmt(end);

            loadSales();
        };

        function renderTable(sales) {
            const tbody = document.getElementById('sales-table-body');
            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500 italic">No se encontraron ventas</td></tr>';
                return;
            }

            tbody.innerHTML = sales.map(s => {
                const date = new Date(s.created_at).toLocaleString('es-MX', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });
                const statusColor = s.status === 'PAID' ? 'text-emerald-400 bg-emerald-400/10' : 'text-amber-400 bg-amber-400/10';

                return `
                <tr class="hover:bg-slate-800/50 transition group">
                    <td class="p-4 font-mono text-slate-300 font-bold">${s.series || ''}-${s.folio || s.id}</td>
                    <td class="p-4 text-slate-400">${date}</td>
                    <td class="p-4 text-slate-300">${s.customer_id ? `Cliente #${s.customer_id}` : 'Publico General'}</td>
                    <td class="p-4 text-right font-bold text-slate-200">$${Number(s.total_amount).toFixed(2)}</td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-1 rounded text-xs font-bold ${statusColor}">${s.status}</span>
                    </td>
                    <td class="p-4 text-right">
                         <button class="text-primary-400 hover:text-white text-sm font-medium transition" onclick="openDetails(${s.id})">Ver Detalles</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // --- DETAILS MODAL ---
        window.openDetails = function (id) {
            const sale = currentSales.find(s => s.id === id);
            if (!sale) return;

            const modal = document.getElementById('details-modal');
            const date = new Date(sale.created_at).toLocaleString();

            document.getElementById('detail-folio').textContent = `Folio #${sale.series || ''}-${sale.folio || sale.id}`;
            document.getElementById('detail-date').textContent = date;

            const badge = document.getElementById('detail-status');
            badge.textContent = sale.status;
            badge.className = `text-[10px] px-2 py-0.5 rounded-full font-bold ${sale.status === 'PAID' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`;

            document.getElementById('detail-total').textContent = `$${Number(sale.total_amount).toFixed(2)}`;

            const itemsBody = document.getElementById('detail-items');
            itemsBody.innerHTML = sale.lines.map(l => `
                <tr>
                    <td class="p-2">${l.description}</td>
                    <td class="p-2 text-center text-slate-400">x${l.quantity}</td>
                    <td class="p-2 text-right text-slate-400">$${Number(l.unit_price).toFixed(2)}</td>
                    <td class="p-2 text-right font-medium text-slate-200">$${Number(l.total_line).toFixed(2)}</td>
                </tr>
            `).join('');

            // Reprint handler
            const reprintBtn = document.getElementById('reprint-btn');
            if (reprintBtn) {
                reprintBtn.onclick = async () => {
                    reprintBtn.disabled = true;
                    reprintBtn.textContent = 'Enviando...';
                    try {
                        await fetch(`${API_BASE}/api/printer/reprint-ticket/${sale.id}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${ACCESS_TOKEN}` }
                        });
                        alert('Ticket enviado a reimpresión');
                    } catch (e) { alert('Error: ' + e.message); }
                    reprintBtn.disabled = false;
                    reprintBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2-2v4h10z"></path></svg> Reimprimir Ticket';
                };
            }

            // Returns Handler
            const returnBtn = document.getElementById('return-btn');
            if (returnBtn) {
                returnBtn.onclick = () => {
                    if (confirm('¿Iniciar proceso de devolución para esta venta?')) {
                        alert('Función de devolución iniciada (Backend pendiente)');
                    }
                };
            }

            modal.classList.remove('hidden');
        };

        const closeBtn = document.getElementById('close-details-btn');
        if (closeBtn) {
            closeBtn.onclick = () => {
                document.getElementById('details-modal').classList.add('hidden');
            };
        }

        // --- INIT ---
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) refreshBtn.onclick = loadSales;
        loadSales(); // Initial load
    });
</script>
{% endblock %}