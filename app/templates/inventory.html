{% extends "base.html" %}

{% block title %}Inventario - Atlas ERP{% endblock %}

{% block content %}
<header
    class="h-16 border-b border-white/5 bg-slate-900/50 backdrop-blur-md flex justify-between items-center px-6 shrink-0 z-10 sticky top-0">
    <div>
        <h1 class="text-lg font-bold text-white tracking-tight">Inventario y Kardex</h1>
        <p class="text-[10px] text-slate-400 uppercase tracking-widest font-semibold">Movimientos de Stock</p>
    </div>
</header>

<div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
    <div class="max-w-6xl mx-auto space-y-6">

        <!-- Controls -->
        <div class="glass-card p-4 rounded-xl flex gap-4 items-center">
            <div class="relative flex-1">
                <span class="absolute inset-y-0 left-3 flex items-center text-slate-400">üîç</span>
                <input id="search-input" type="text" placeholder="Buscar producto (SKU, Nombre)..."
                    class="w-full pl-10 pr-4 py-2 rounded-lg bg-slate-950 border border-slate-800 text-white outline-none focus:ring-2 focus:ring-primary-500 transition">
            </div>
        </div>

        <!-- Table -->
        <div class="glass-card rounded-2xl overflow-hidden glass-panel">
            <table class="min-w-full divide-y divide-slate-800">
                <thead class="bg-slate-900/50">
                    <tr>
                        <th class="px-6 py-4 text-left text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                            SKU</th>
                        <th class="px-6 py-4 text-left text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                            Producto</th>
                        <th class="px-6 py-4 text-center text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                            Stock Actual</th>
                        <th class="px-6 py-4 text-right text-[10px] font-bold text-slate-400 uppercase tracking-wider">
                            Acciones</th>
                    </tr>
                </thead>
                <tbody id="inventory-table-body" class="divide-y divide-slate-800 text-sm text-slate-300">
                    <!-- JS Rows -->
                </tbody>
            </table>
        </div>

    </div>
</div>
{% endblock %}

{% block modals %}
<!-- Adjust Modal -->
<div id="adjust-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-xl shadow-2xl w-full max-w-sm p-6 border border-slate-700">
        <h3 class="text-lg font-bold text-white mb-1">Ajuste de Inventario</h3>
        <p id="adjust-product-name" class="text-xs text-slate-400 mb-4 font-mono"></p>

        <form id="adjust-form" class="space-y-4">
            <input type="hidden" id="adjust-variant-id">

            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Cantidad (+/-)</label>
                <input type="number" id="adjust-qty" step="any" required
                    class="w-full px-4 py-2 bg-slate-950 border border-slate-800 rounded-lg text-white font-bold text-lg outline-none focus:ring-2 focus:ring-emerald-500">
                <p class="text-[10px] text-slate-500 mt-1">Usa positivo para entradas, negativo para salidas.</p>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Motivo</label>
                <select id="adjust-reason"
                    class="w-full px-4 py-2 bg-slate-950 border border-slate-800 rounded-lg text-white outline-none">
                    <option value="Compra">Compra / Resurtido</option>
                    <option value="Ajuste Inicial">Ajuste Inicial</option>
                    <option value="Merma">Merma / Da√±ado</option>
                    <option value="Uso Interno">Uso Interno</option>
                    <option value="Correcci√≥n">Correcci√≥n de Inventario</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Notas</label>
                <textarea id="adjust-notes" rows="2"
                    class="w-full px-4 py-2 bg-slate-950 border border-slate-800 rounded-lg text-white outline-none text-xs"></textarea>
            </div>

            <div class="flex justify-end gap-2 pt-2">
                <button type="button" onclick="document.getElementById('adjust-modal').classList.add('hidden')"
                    class="px-4 py-2 text-slate-400 hover:text-white transition">Cancelar</button>
                <button type="submit"
                    class="bg-emerald-600 hover:bg-emerald-500 text-white px-6 py-2 rounded-lg font-bold transition shadow-lg">Aplicar
                    Ajuste</button>
            </div>
        </form>
    </div>
</div>

<!-- Kardex Modal -->
<div id="kardex-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl p-6 border border-slate-700 h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-4 shrink-0">
            <div>
                <h3 class="text-lg font-bold text-white">Kardex (Historial)</h3>
                <p id="kardex-product-name" class="text-xs text-emerald-400 font-mono"></p>
            </div>
            <button onclick="document.getElementById('kardex-modal').classList.add('hidden')"
                class="text-slate-400 hover:text-white">‚úï</button>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar bg-slate-950/50 rounded-lg border border-slate-800">
            <table class="min-w-full divide-y divide-slate-800">
                <thead class="bg-slate-900 sticky top-0">
                    <tr>
                        <th class="px-4 py-3 text-left text-[10px] text-slate-400 uppercase">Fecha</th>
                        <th class="px-4 py-3 text-left text-[10px] text-slate-400 uppercase">Tipo</th>
                        <th class="px-4 py-3 text-center text-[10px] text-slate-400 uppercase">Cant</th>
                        <th class="px-4 py-3 text-center text-[10px] text-slate-400 uppercase">Saldo</th>
                        <th class="px-4 py-3 text-left text-[10px] text-slate-400 uppercase">Ref / Usuario</th>
                    </tr>
                </thead>
                <tbody id="kardex-table-body" class="divide-y divide-slate-800 text-xs text-slate-300"></tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Reusing API Fetch logic from base or Products
        // Assuming base.html doesn't export it globally, I'll copy a minimal version.
        // Ideally should be in a shared utils.js
        const API_BASE_URL = 'http://127.0.0.1:8000';
        let ACCESS_TOKEN = sessionStorage.getItem('ACCESS_TOKEN');

        async function apiFetch(endpoint, options = {}) {
            const headers = { 'Authorization': `Bearer ${ACCESS_TOKEN}`, ...options.headers };
            if (options.body && !(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
            const res = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
            if (res.status === 401) { window.location.href = '/auth'; }
            if (!res.ok) throw new Error((await res.json()).detail || res.statusText);
            return res.json();
        }

        let allProducts = [];

        loadData();

        async function loadData() {
            try {
                // Reusing products endpoint for list, it contains stock info
                const prods = await apiFetch('/api/products/?limit=1000');
                allProducts = prods;
                renderTable(prods);
            } catch (e) { console.error(e); }
        }

        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(q) || p.sku.toLowerCase().includes(q));
            renderTable(filtered);
        });

        function renderTable(products) {
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = products.map(p => {
                const stock = p.stock_levels?.[0]?.qty_on_hand || 0;
                const style = stock > 0 ? 'text-emerald-400' : 'text-rose-400';
                // Use main variant ID for adjustments
                const variantId = p.variants?.[0]?.id;

                return `
            <tr class="hover:bg-slate-800/50 transition border-b border-slate-800">
                <td class="px-6 py-4 font-mono text-xs text-slate-400">${p.sku}</td>
                <td class="px-6 py-4 font-bold text-white text-xs">${p.name}</td>
                <td class="px-6 py-4 text-center text-sm font-bold ${style}">${stock}</td>
                <td class="px-6 py-4 text-right space-x-2">
                    <button onclick="openAdjust(${variantId}, '${p.sku} - ${p.name}')" 
                        class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-1 rounded text-xs font-bold border border-slate-700">Ajustar</button>
                    <button onclick="openKardex(${variantId}, '${p.name}')"
                        class="text-primary-400 hover:text-white text-xs font-bold underline">Kardex</button>
                </td>
            </tr>
            `;
            }).join('');
        }

        // --- ADJUST LOGIC ---
        window.openAdjust = (vid, name) => {
            if (!vid) return alert('Este producto no tiene variante principal v√°lida');
            document.getElementById('adjust-variant-id').value = vid;
            document.getElementById('adjust-product-name').textContent = name;
            document.getElementById('adjust-qty').value = '';
            document.getElementById('adjust-notes').value = '';
            document.getElementById('adjust-modal').classList.remove('hidden');
        };

        document.getElementById('adjust-form').onsubmit = async (e) => {
            e.preventDefault();
            const vid = document.getElementById('adjust-variant-id').value;
            const qty = parseFloat(document.getElementById('adjust-qty').value);
            const reason = document.getElementById('adjust-reason').value;
            const notes = document.getElementById('adjust-notes').value;

            try {
                await apiFetch('/api/inventory/adjust', {
                    method: 'POST',
                    body: JSON.stringify({ variant_id: vid, quantity: qty, reason, notes })
                });
                document.getElementById('adjust-modal').classList.add('hidden');
                loadData(); // Refresh stock
                alert('Ajuste aplicado correctamente');
            } catch (err) { alert(err.message); }
        };

        // --- KARDEX LOGIC ---
        window.openKardex = async (vid, name) => {
            if (!vid) return;
            document.getElementById('kardex-product-name').textContent = name;
            document.getElementById('kardex-modal').classList.remove('hidden');
            const tbody = document.getElementById('kardex-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Cargando...</td></tr>';

            try {
                const moves = await apiFetch(`/api/inventory/kardex/${vid}`);
                tbody.innerHTML = moves.map(m => `
                <tr class="border-b border-slate-800 last:border-0 hover:bg-slate-800/30">
                    <td class="px-4 py-2 text-slate-500">${new Date(m.created_at).toLocaleString()}</td>
                    <td class="px-4 py-2 text-white font-bold">${formatType(m.movement_type)}</td>
                    <td class="px-4 py-2 text-center font-mono ${m.qty_change > 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${m.qty_change > 0 ? '+' : ''}${m.qty_change}
                    </td>
                    <td class="px-4 py-2 text-center text-slate-300 font-bold">${m.qty_after}</td>
                    <td class="px-4 py-2 text-slate-500 overflow-hidden text-ellipsis whitespace-nowrap max-w-[150px]">
                        <span class="block text-white text-[10px]">${m.reference || ''}</span>
                        <span class="block text-[9px]">${m.user_name}</span>
                    </td>
                </tr>
            `).join('');
            } catch (err) { tbody.innerHTML = `<tr><td colspan="5" class="text-center text-rose-500 py-4">${err.message}</td></tr>`; }
        };

        function formatType(t) {
            if (t === 'ADJUSTMENT_IN') return 'Entrada';
            if (t === 'ADJUSTMENT_OUT') return 'Salida';
            if (t === 'SALE') return 'Venta';
            if (t === 'PURCHASE') return 'Compra';
            if (t === 'SALE_RETURN') return 'Devoluci√≥n';
            return t;
        }
    });
</script>
{% endblock %}