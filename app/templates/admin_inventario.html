<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Inventario | DataX POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { colors: { slate: { 850: '#172033', 950: '#020617' } } }
            }
        }
    </script>
    <style>
        .hidden { display: none; }
        .modal { transition: opacity 0.2s ease, visibility 0.2s ease; opacity: 0; visibility: hidden; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { transition: transform 0.2s ease; transform: scale(0.95); }
        .modal.active .modal-content { transform: scale(1); }
        .spinner { border-top-color: #8b5cf6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-slate-950 dark:text-slate-100 font-sans transition-colors duration-300 overflow-hidden">

    <!-- 1. PANTALLA DE LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-950">
        <div class="w-full max-w-sm bg-slate-900 border border-slate-800 rounded-3xl p-8 shadow-2xl">
            <div class="flex justify-center mb-6">
                <div class="w-12 h-12 bg-gradient-to-br from-violet-600 to-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg">DX</div>
            </div>
            <h2 class="text-xl font-bold text-center text-white mb-6">Admin Inventario</h2>
            <form id="login-form" class="space-y-4">
                <input id="username" type="text" class="w-full px-4 py-3 bg-slate-950 border border-slate-700 rounded-xl text-white focus:ring-2 focus:ring-violet-500 outline-none" placeholder="Usuario" required>
                <input id="pin" type="password" inputmode="numeric" class="w-full px-4 py-3 bg-slate-950 border border-slate-700 rounded-xl text-white focus:ring-2 focus:ring-violet-500 outline-none" placeholder="PIN" required>
                <p id="login-error" class="hidden text-sm text-red-400 text-center"></p>
                <button type="submit" class="w-full py-3 bg-violet-600 hover:bg-violet-500 text-white font-bold rounded-xl transition">Acceder</button>
            </form>
        </div>
    </div>

    <!-- 2. LAYOUT PRINCIPAL -->
    <div id="main-layout" class="hidden flex h-screen w-full">
        
        <!-- SIDEBAR -->
        <div id="global-sidebar"></div>

        <!-- CONTENIDO -->
        <main class="flex-1 flex flex-col min-w-0 bg-gray-100 dark:bg-slate-950 relative overflow-hidden">
            
            <!-- HEADER -->
            <header class="h-16 border-b border-gray-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur flex justify-between items-center px-6 shrink-0 z-10">
                <div>
                    <h1 class="text-lg font-bold text-gray-800 dark:text-white">Gesti√≥n de Inventario</h1>
                    <p class="text-[10px] text-gray-500 dark:text-slate-400 uppercase tracking-widest font-semibold">Existencias y Ajustes</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-800 text-slate-500 transition">
                        <span id="icon-sun" class="hidden">‚òÄÔ∏è</span><span id="icon-moon">üåô</span>
                    </button>
                    <div class="h-6 w-px bg-gray-300 dark:bg-slate-700 mx-2"></div>
                    <button id="logout-button" class="p-2 text-slate-400 hover:text-red-500 hover:bg-slate-800 rounded-lg transition" title="Salir">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </header>

            <!-- √ÅREA SCROLLABLE -->
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <div class="max-w-7xl mx-auto space-y-6">
                    
                    <!-- ACCIONES PRINCIPALES -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div>
                            <h2 class="text-xl font-semibold text-slate-800 dark:text-slate-50">Control de Stock</h2>
                            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Monitorea niveles y realiza ajustes r√°pidos.</p>
                        </div>
                        <div class="flex flex-wrap items-center gap-3">
                            <label class="inline-flex items-center gap-2 text-xs font-bold text-slate-500 dark:text-slate-400 bg-white dark:bg-slate-900 px-3 py-2 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm cursor-pointer hover:border-violet-500 transition select-none">
                                <input type="checkbox" id="auto-refresh-toggle" class="rounded bg-slate-200 dark:bg-slate-800 border-slate-400 text-violet-600 focus:ring-violet-500">
                                Auto-Refresco (60s)
                            </label>
                            
                            <button id="refresh-button" class="flex items-center gap-2 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-xl text-xs font-bold hover:bg-gray-50 dark:hover:bg-slate-700 transition shadow-sm">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                Actualizar
                            </button>

                            <button id="import-stock-button" class="flex items-center gap-2 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-xl text-xs font-bold hover:bg-gray-50 dark:hover:bg-slate-700 transition shadow-sm">
                                <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                Cargar Excel
                            </button>
                            
                            <button id="export-button" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-emerald-500/20 transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Exportar CSV
                            </button>
                        </div>
                    </div>

                    <!-- KPIs -->
                    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <article class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm">
                            <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-2">SKUs √önicos</p>
                            <div class="flex items-end justify-between">
                                <p id="stat-total-skus" class="text-3xl font-black text-slate-800 dark:text-slate-50">0</p>
                                <span class="text-xs text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">Productos</span>
                            </div>
                        </article>
                        <article class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm">
                            <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-2">Total Unidades</p>
                            <div class="flex items-end justify-between">
                                <p id="stat-total-units" class="text-3xl font-black text-violet-500">0</p>
                                <span class="text-xs text-slate-400 bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">Pzas en f√≠sico</span>
                            </div>
                        </article>
                        <article class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm">
                            <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-2">Bajo Stock</p>
                            <div class="flex items-end justify-between">
                                <p id="stat-low-stock" class="text-3xl font-black text-amber-500">0</p>
                                <span class="text-xs text-amber-600 bg-amber-100 dark:bg-amber-900/20 px-2 py-1 rounded">Reordenar</span>
                            </div>
                        </article>
                        <article class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm">
                            <p class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mb-2">Agotados</p>
                            <div class="flex items-end justify-between">
                                <p id="stat-zero-stock" class="text-3xl font-black text-rose-500">0</p>
                                <span class="text-xs text-rose-600 bg-rose-100 dark:bg-rose-900/20 px-2 py-1 rounded">Sin venta</span>
                            </div>
                        </article>
                    </section>

                    <!-- FILTROS -->
                    <section class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 rounded-2xl p-4 shadow-sm">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="relative flex-1">
                                <span class="absolute inset-y-0 left-3 flex items-center text-slate-400">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                </span>
                                <input id="search-input" type="text" placeholder="Buscar por SKU, nombre..." class="w-full pl-10 pr-4 py-2.5 rounded-xl bg-gray-50 dark:bg-slate-950 border border-gray-300 dark:border-slate-700 text-sm focus:ring-2 focus:ring-violet-500 outline-none transition">
                            </div>
                            <select id="department-filter" class="px-4 py-2.5 rounded-xl bg-gray-50 dark:bg-slate-950 border border-gray-300 dark:border-slate-700 text-sm focus:ring-2 focus:ring-violet-500 outline-none cursor-pointer">
                                <option value="ALL">Todos los Departamentos</option>
                            </select>
                            <div class="flex items-center bg-gray-50 dark:bg-slate-950 border border-gray-300 dark:border-slate-700 rounded-xl px-4">
                                <label class="inline-flex items-center gap-2 text-sm font-medium text-slate-600 dark:text-slate-300 cursor-pointer select-none">
                                    <input type="checkbox" id="low-stock-toggle" class="rounded bg-slate-200 dark:bg-slate-800 border-slate-400 text-amber-500 focus:ring-amber-500">
                                    Solo Bajo Stock
                                </label>
                            </div>
                        </div>
                    </section>

                    <!-- TABLA -->
                    <section class="bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-800 rounded-2xl overflow-hidden shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-800">
                                <thead class="bg-gray-50 dark:bg-slate-950/50">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider">SKU</th>
                                        <th class="px-6 py-4 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider">Producto</th>
                                        <th class="px-6 py-4 text-left text-[10px] font-bold text-slate-500 uppercase tracking-wider">Depto</th>
                                        <th class="px-6 py-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">Existencias</th>
                                        <th class="px-6 py-4 text-center text-[10px] font-bold text-slate-500 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-4 text-right text-[10px] font-bold text-slate-500 uppercase tracking-wider">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body" class="bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-slate-800 text-sm">
                                    <!-- JS -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>

            <!-- FOOTER GLOBAL -->
            <div id="global-footer"></div>

        </main>
    </div>

    <!-- MODALES -->
    
    <!-- Modal Ajuste Stock -->
    <div id="stock-modal" class="modal fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700 p-6 rounded-2xl shadow-2xl w-full max-w-md">
            <h3 id="modal-title" class="text-lg font-bold text-slate-800 dark:text-white mb-1">Ajuste R√°pido</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-6">Ingresa la cantidad a sumar o restar.</p>

            <form id="stock-form" class="space-y-4">
                <input type="hidden" id="adjustment-product-id">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Cantidad a Agregar</label>
                    <div class="relative">
                        <input type="number" id="adjustment-quantity" step="0.01" class="w-full px-4 py-3 bg-gray-50 dark:bg-slate-950 border border-gray-300 dark:border-slate-700 rounded-xl text-lg font-bold focus:ring-2 focus:ring-violet-500 outline-none" placeholder="0" required>
                        <div class="absolute right-3 top-3 flex gap-1">
                            <button type="button" class="text-xs bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded font-bold hover:bg-slate-300" onclick="setQty(1)">+1</button>
                            <button type="button" class="text-xs bg-slate-200 dark:bg-slate-800 px-2 py-1 rounded font-bold hover:bg-slate-300" onclick="setQty(10)">+10</button>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-1">Usa n√∫meros negativos (ej: -5) para restar/mermas.</p>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">Nota / Raz√≥n</label>
                    <input type="text" id="adjustment-notes" class="w-full px-4 py-2.5 bg-gray-50 dark:bg-slate-950 border border-gray-300 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-violet-500 outline-none" placeholder="Ej: Compra proveedor, Merma...">
                </div>

                <p id="modal-error" class="text-red-500 text-xs text-center hidden font-bold"></p>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="cancel-modal-button" class="px-4 py-2 rounded-xl text-slate-500 hover:bg-gray-100 dark:hover:bg-slate-800 font-bold text-sm transition">Cancelar</button>
                    <button type="submit" id="save-adjustment-button" class="px-6 py-2 rounded-xl bg-violet-600 hover:bg-violet-500 text-white font-bold text-sm shadow-lg transition">Guardar Ajuste</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Importar Excel (Nuevo) -->
    <div id="upload-modal" class="modal fixed inset-0 bg-black/70 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-md w-full p-6 border border-gray-200 dark:border-slate-700">
            <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-white">Carga Masiva de Stock</h3>
            <form id="upload-form">
                <div id="upload-step-1">
                    <label class="block w-full p-8 border-2 border-dashed border-gray-300 dark:border-slate-700 rounded-xl text-center cursor-pointer hover:border-violet-500 hover:bg-gray-50 dark:hover:bg-slate-800/50 transition mb-4">
                        <svg class="w-10 h-10 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="text-sm font-medium text-gray-600 dark:text-slate-300">Clic para subir .xlsx</span>
                        <input type="file" id="excel-file-input" class="hidden" accept=".xlsx" required>
                    </label>
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg text-xs text-blue-700 dark:text-blue-300 mb-4">
                        <strong>Columnas requeridas:</strong> SKU, Cantidad
                    </div>
                    <div class="flex justify-end gap-3">
                        <button type="button" id="cancel-upload-button" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow">Procesar</button>
                    </div>
                </div>
                
                <!-- Spinner y Resultados (reutilizando l√≥gica) -->
                <div id="upload-step-2" class="hidden text-center py-8"><div class="spinner w-10 h-10 border-4 border-gray-200 border-t-violet-600 rounded-full mx-auto"></div><p class="mt-4 text-sm">Procesando...</p></div>
                <div id="upload-step-3" class="hidden text-center"><h4 class="font-bold text-lg text-emerald-500 mb-2">¬°Listo!</h4><p id="upload-summary" class="text-sm mb-4"></p><button type="button" onclick="location.reload()" class="w-full py-2 bg-gray-800 text-white rounded-lg">Cerrar</button></div>
            </form>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="js/navbar.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CONFIG
            const API_BASE_URL = 'http://127.0.0.1:8000';
            let ACCESS_TOKEN = null;
            let CURRENT_USER = null;
            let fullInventory = [];
            let AUTO_REFRESH_INTERVAL = null;
            const LOW_STOCK_LIMIT = 5;

            // AUTH & THEME
            const themeToggle = document.getElementById('theme-toggle');
            const iconSun = document.getElementById('icon-sun');
            const iconMoon = document.getElementById('icon-moon');

            function initTheme() {
                if (localStorage.getItem('theme') === 'light') {
                    document.documentElement.classList.remove('dark');
                    if(iconSun) { iconSun.classList.remove('hidden'); iconMoon.classList.add('hidden'); }
                } else {
                    document.documentElement.classList.add('dark');
                    if(iconSun) { iconSun.classList.add('hidden'); iconMoon.classList.remove('hidden'); }
                }
            }
            initTheme();

            if(themeToggle) themeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                initTheme();
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const res = await fetch(`${API_BASE_URL}/api/auth/login`, {
                        method: 'POST',
                        body: new URLSearchParams({ username: document.getElementById('username').value, password: document.getElementById('pin').value }),
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'}
                    });
                    if(!res.ok) throw new Error('Credenciales inv√°lidas');
                    const data = await res.json();
                    const payload = JSON.parse(atob(data.access_token.split('.')[1]));
                    if(!['ADMINISTRADOR', 'GERENTE', 'DUE√ëO'].includes(payload.role)) throw new Error('Acceso denegado');

                    sessionStorage.setItem('ACCESS_TOKEN', data.access_token);
                    sessionStorage.setItem('CURRENT_USER', JSON.stringify(payload));
                    location.reload();
                } catch(e) { 
                    document.getElementById('login-error').textContent = e.message; 
                    document.getElementById('login-error').classList.remove('hidden'); 
                }
            });

            function checkLogin() {
                if(sessionStorage.getItem('ACCESS_TOKEN')) {
                    ACCESS_TOKEN = sessionStorage.getItem('ACCESS_TOKEN');
                    CURRENT_USER = JSON.parse(sessionStorage.getItem('CURRENT_USER'));
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-layout').classList.remove('hidden');
                    loadInventory();
                }
            }
            checkLogin();
            document.getElementById('logout-button').onclick = () => { sessionStorage.clear(); location.reload(); };

            // API
            async function apiFetch(endpoint, options = {}) {
                const headers = { 'Authorization': `Bearer ${ACCESS_TOKEN}`, ...options.headers };
                if(options.body && !(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
                const res = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
                if(res.status === 401) { sessionStorage.clear(); location.reload(); }
                if(!res.ok) throw new Error((await res.json()).detail || 'Error API');
                return res.status === 204 ? null : res.json();
            }

            // INVENTARIO
            document.getElementById('refresh-button').onclick = loadInventory;
            document.getElementById('auto-refresh-toggle').onchange = (e) => {
                if(e.target.checked) {
                    if(AUTO_REFRESH_INTERVAL) clearInterval(AUTO_REFRESH_INTERVAL);
                    AUTO_REFRESH_INTERVAL = setInterval(loadInventory, 60000);
                } else {
                    if(AUTO_REFRESH_INTERVAL) clearInterval(AUTO_REFRESH_INTERVAL);
                }
            };

            async function loadInventory() {
                try {
                    const stock = await apiFetch('/api/inventory/');
                    fullInventory = Array.isArray(stock) ? stock : [];
                    buildFilters(fullInventory);
                    updateStats(fullInventory);
                    applyFilters();
                } catch(e) { console.error(e); }
            }

            function buildFilters(data) {
                const depts = new Set(data.map(i => i.product?.department?.name || 'Sin Depto'));
                const sel = document.getElementById('department-filter');
                sel.innerHTML = '<option value="ALL">Todos los Departamentos</option>';
                depts.forEach(d => sel.innerHTML += `<option value="${d}">${d}</option>`);
            }

            function updateStats(data) {
                let totalUnits = 0, low = 0, zero = 0;
                data.forEach(i => {
                    const q = i.qty_on_hand || 0;
                    totalUnits += q;
                    if(q <= 0) zero++;
                    else if(q <= LOW_STOCK_LIMIT) low++;
                });
                document.getElementById('stat-total-skus').textContent = data.length;
                document.getElementById('stat-total-units').textContent = totalUnits;
                document.getElementById('stat-low-stock').textContent = low;
                document.getElementById('stat-zero-stock').textContent = zero;
            }

            // FILTROS
            const searchInput = document.getElementById('search-input');
            const deptFilter = document.getElementById('department-filter');
            const lowToggle = document.getElementById('low-stock-toggle');

            [searchInput, deptFilter, lowToggle].forEach(el => el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', applyFilters));

            function applyFilters() {
                const q = searchInput.value.toLowerCase();
                const dept = deptFilter.value;
                const onlyLow = lowToggle.checked;

                const filtered = fullInventory.filter(i => {
                    const p = i.product || {};
                    const matchText = (p.name||'').toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q);
                    const matchDept = dept === 'ALL' || (p.department?.name || 'Sin Depto') === dept;
                    const matchLow = !onlyLow || (i.qty_on_hand || 0) <= LOW_STOCK_LIMIT;
                    return matchText && matchDept && matchLow;
                });

                renderTable(filtered);
            }

            function renderTable(data) {
                const tbody = document.getElementById('inventory-table-body');
                if(!data.length) { tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500 italic">No se encontraron resultados.</td></tr>'; return; }
                
                tbody.innerHTML = data.map(i => {
                    const p = i.product || {};
                    const qty = i.qty_on_hand || 0;
                    const statusClass = qty <= 0 ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400' : qty <= LOW_STOCK_LIMIT ? 'bg-amber-100 text-amber-600 dark:bg-amber-900/30 dark:text-amber-400' : 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/30 dark:text-emerald-400';
                    const statusText = qty <= 0 ? 'Agotado' : qty <= LOW_STOCK_LIMIT ? 'Bajo' : 'Normal';

                    return `
                        <tr class="hover:bg-gray-50 dark:hover:bg-slate-800/50 transition">
                            <td class="px-6 py-4 font-mono text-xs font-bold text-slate-500 dark:text-slate-400">${p.sku || '-'}</td>
                            <td class="px-6 py-4 font-bold text-gray-800 dark:text-white text-xs">${p.name || 'Producto'}</td>
                            <td class="px-6 py-4 text-xs text-slate-500">${p.department?.name || '-'}</td>
                            <td class="px-6 py-4 text-center font-bold text-lg text-slate-700 dark:text-slate-200">${qty}</td>
                            <td class="px-6 py-4 text-center"><span class="px-2 py-1 rounded text-[10px] font-bold ${statusClass}">${statusText}</span></td>
                            <td class="px-6 py-4 text-right">
                                <button class="text-violet-500 hover:text-violet-400 font-bold text-xs adjust-btn bg-violet-50 dark:bg-violet-900/20 px-3 py-1 rounded hover:bg-violet-100 dark:hover:bg-violet-900/40 transition" 
                                    data-id="${p.id}" data-name="${p.name}">Ajustar</button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                document.querySelectorAll('.adjust-btn').forEach(b => b.onclick = () => openAdjustModal(b.dataset));
            }

            // MODAL AJUSTE
            const modal = document.getElementById('stock-modal');
            function openAdjustModal(data) {
                document.getElementById('stock-form').reset();
                document.getElementById('adjustment-product-id').value = data.id;
                document.getElementById('modal-title').textContent = `Ajustar: ${data.name}`;
                modal.classList.remove('hidden'); modal.classList.add('flex');
                setTimeout(()=>modal.classList.add('active'),10);
                setTimeout(()=>document.getElementById('adjustment-quantity').focus(),100);
            }
            function hideModal() { modal.classList.remove('active'); setTimeout(()=>{modal.classList.add('hidden'); modal.classList.remove('flex')},200); }
            
            document.getElementById('cancel-modal-button').onclick = hideModal;
            
            window.setQty = (val) => {
                const input = document.getElementById('adjustment-quantity');
                input.value = (parseFloat(input.value||0) + val);
            };

            document.getElementById('stock-form').onsubmit = async (e) => {
                e.preventDefault();
                const qty = parseFloat(document.getElementById('adjustment-quantity').value);
                if(isNaN(qty) || qty === 0) return alert('Cantidad inv√°lida');
                
                const payload = {
                    product_id: parseInt(document.getElementById('adjustment-product-id').value),
                    quantity_to_add: qty,
                    notes: document.getElementById('adjustment-notes').value
                };

                try {
                    await apiFetch('/api/inventory/adjust', { method:'POST', body: JSON.stringify(payload)});
                    hideModal();
                    loadInventory();
                } catch(e) { alert(e.message); }
            };

            // IMPORT EXCEL
            const upModal = document.getElementById('upload-modal');
            document.getElementById('import-stock-button').onclick = () => {
                document.getElementById('upload-step-1').classList.remove('hidden');
                document.getElementById('upload-step-2').classList.add('hidden');
                document.getElementById('upload-step-3').classList.add('hidden');
                upModal.classList.remove('hidden'); upModal.classList.add('flex', 'active');
            };
            document.getElementById('cancel-upload-button').onclick = () => { upModal.classList.remove('active'); setTimeout(()=>upModal.classList.add('hidden'),200); };
            
            document.getElementById('upload-form').onsubmit = async (e) => {
                e.preventDefault();
                const file = document.getElementById('excel-file-input').files[0];
                if(!file) return;

                document.getElementById('upload-step-1').classList.add('hidden');
                document.getElementById('upload-step-2').classList.remove('hidden');

                const fd = new FormData(); fd.append('file', file);
                try {
                    // Asumimos un endpoint similar al de productos para inventario (ajuste masivo)
                    // Si no existe, mostrar√° error pero la UI est√° lista.
                    const res = await apiFetch('/api/inventory/upload', { method:'POST', body: fd });
                    document.getElementById('upload-summary').textContent = `Procesados: ${res.processed || 0}, Errores: ${res.errors?.length || 0}`;
                    document.getElementById('upload-step-2').classList.add('hidden');
                    document.getElementById('upload-step-3').classList.remove('hidden');
                    loadInventory();
                } catch(e) {
                    alert("Nota: Requiere backend endpoint /api/inventory/upload. Error: " + e.message);
                    document.getElementById('cancel-upload-button').click();
                }
            };

            // EXPORT
            document.getElementById('export-button').onclick = () => {
                const data = fullInventory.map(i => `${i.product?.sku},"${i.product?.name}",${i.qty_on_hand}`).join('\n');
                const blob = new Blob([`SKU,Producto,Cantidad\n${data}`], {type:'text/csv'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download='inventario.csv'; a.click();
            };
        });
    </script>
</body>
</html>